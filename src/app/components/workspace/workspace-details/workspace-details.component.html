<div *ngIf="loading; else content">
  <mat-progress-bar mode="indeterminate"></mat-progress-bar>
</div>
<ng-template #content>
  <mat-sidenav-container autosize>
    <mat-sidenav mode="side" opened disableClose="true">
      <mat-form-field appearance="fill">
        <mat-label> <mat-icon>search</mat-icon> Search </mat-label>
        <input matInput (keyup)="applyFilter($event)" />
      </mat-form-field>
      <mat-nav-list>
        <a mat-list-item (click)="openDialog('', '', '')">
          <mat-icon matListItemIcon>create_new_folder</mat-icon>
          <div matListItemTitle>Add sequence</div>
        </a>

        <a
          [disabled]="checkingAvailability"
          mat-list-item
          (click)="predictAll()"
        >
          <mat-icon matListItemIcon>find_replace</mat-icon>
          <div matListItemTitle>Predict all</div>
        </a>
        <a mat-list-item disabled="true">
          <mat-icon matListItemIcon>unarchive</mat-icon>
          <div matListItemTitle>Export results</div>
        </a>
        <a
          mat-list-item
          [routerLink]="'/workspaces/settings'"
          [queryParams]="{ id: workspace ? workspace.id : '' }"
          queryParamsHandling="merge"
        >
          <mat-icon matListItemIcon>settings</mat-icon>
          <div matListItemTitle>Configure</div>
        </a>
      </mat-nav-list>
      <mat-button-toggle-group
        style="width: 100%; border: 0; margin-top: 50px"
        vertical
        #group="matButtonToggleGroup"
        [disabled]="checkingAvailability"
        (change)="onModelChange($event.value)"
      >
        <mat-button-toggle value="AmBERT" checked> AmBERT </mat-button-toggle>
        <mat-button-toggle value="LSTM"> LSTM </mat-button-toggle>
      </mat-button-toggle-group>
      <mat-card *ngIf="predictingAll">
        <mat-card-header>
          <mat-card-subtitle>Running predictions</mat-card-subtitle>
          <mat-card-title>{{ currentlyPredictedSequence }}</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <p>{{ currentlyPredictedIndex }}/{{ totalPredictions }}</p>
          <mat-divider></mat-divider>
        </mat-card-content>
        <mat-card-footer>
          <mat-progress-bar mode="indeterminate"></mat-progress-bar>
        </mat-card-footer>
      </mat-card>
      <mat-card *ngIf="predictingSingle">
        <mat-card-header>
          <mat-card-subtitle>Running prediction</mat-card-subtitle>
          <mat-card-title>{{ currentlyPredictedSequence }}</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <mat-divider></mat-divider>
        </mat-card-content>
        <mat-card-footer>
          <mat-progress-bar mode="indeterminate"></mat-progress-bar>
        </mat-card-footer>
      </mat-card>
      <mat-card *ngIf="savingWorkspace">
        <mat-card-header>
          <mat-card-subtitle>Saving changes</mat-card-subtitle>
          <mat-card-title>{{ currentlyPredictedSequence }}</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <mat-divider></mat-divider>
        </mat-card-content>
        <mat-card-footer>
          <mat-progress-bar mode="indeterminate"></mat-progress-bar>
        </mat-card-footer>
      </mat-card>
      <mat-card *ngIf="checkingAvailability || connectionErrorText">
        <mat-card-header>
          <mat-card-subtitle>Checking model availability</mat-card-subtitle>
          <mat-card-title>{{ currentlySelectedModel }}</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <span *ngIf="connectionErrorText" style="color: red">{{
            connectionErrorText
          }}</span>
          <mat-divider></mat-divider>
        </mat-card-content>
        <mat-card-footer>
          <mat-progress-bar
            *ngIf="!connectionErrorText"
            mode="indeterminate"
          ></mat-progress-bar>
        </mat-card-footer>
      </mat-card>
    </mat-sidenav>
    <mat-sidenav-content>
      <div class="mat-table">
        <table
          mat-table
          [dataSource]="dataSource"
          matSort
          matSortDisableClear
          multiTemplateDataRows
        >
          <ng-container matColumnDef="expand">
            <th mat-header-cell *matHeaderCellDef>
              <button mat-icon-button (click)="toggleExpand()">
                <mat-icon>sort</mat-icon>
              </button>
            </th>
            <td mat-cell *matCellDef="let element">
              <button
                mat-icon-button
                (click)="element.expanded = !element.expanded"
              >
                <mat-icon>{{
                  element.expanded ? "keyboard_arrow_up" : "keyboard_arrow_down"
                }}</mat-icon>
              </button>
            </td>
          </ng-container>
          <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>
              Identifier
            </th>
            <td mat-cell *matCellDef="let element">{{ element.name }}</td>
          </ng-container>
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
            <td mat-cell *matCellDef="let element">
              <mat-icon *ngIf="!element.status">question_mark</mat-icon>
              <mat-icon
                style="color: green"
                *ngIf="element.status === 'POSITIVE'"
                >check</mat-icon
              >
              <mat-icon style="color: red" *ngIf="element.status === 'NEGATIVE'"
                >close</mat-icon
              >
            </td>
          </ng-container>

          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Actions</th>
            <td mat-cell *matCellDef="let element">
              <button
                mat-mini-fab
                class="action-button"
                title="Run prediction"
                color="primary"
                (click)="predict(element)"
                [disabled]="
                  processRunning() ||
                  checkingAvailability ||
                  connectionErrorText ||
                  predictionExists(element)
                "
              >
                <mat-icon style="margin: 0">youtube_searched_for</mat-icon>
              </button>
              <button
                mat-mini-fab
                class="action-button"
                title="Edit"
                color="primary"
                (click)="openDialog(element.name, element.value, element.id)"
                [disabled]="processRunning()"
              >
                <mat-icon style="margin: 0">edit</mat-icon>
              </button>
              <button
                mat-mini-fab
                class="action-button"
                title="Delete"
                color="primary"
                (click)="deleteSequence(element.id)"
                [disabled]="processRunning()"
              >
                <mat-icon style="margin: 0">delete</mat-icon>
              </button>
            </td>
          </ng-container>
          <ng-container matColumnDef="notes">
            <th mat-header-cell *matHeaderCellDef>Notes</th>
            <td mat-cell *matCellDef="let element">
              <p *ngIf="element.edited">Edited by user</p>
              <p *ngIf="element.value.length < 40">
                Sequence length may be too short for this model
              </p>
            </td>
          </ng-container>

          <ng-container matColumnDef="expandedDetail">
            <td
              mat-cell
              *matCellDef="let element"
              [attr.colspan]="displayedColumns.length"
            >
              <div *ngIf="element.expanded" class="element-detail">
                <span class="element-header" style="margin-top: 10px">
                  1--------10--------20--------30--------40
                </span>
                <span
                  class="element-description"
                  [innerHTML]="getColoredRepresentation(element) | noSanitize"
                  style="margin-bottom: 10px"
                >
                </span>
              </div>
            </td>
          </ng-container>
          <tr
            mat-header-row
            *matHeaderRowDef="displayedColumns; sticky: true"
          ></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
          <tr
            mat-row
            *matRowDef="let row; columns: ['expandedDetail']"
            class="detail"
          ></tr>
        </table>
      </div>
      <mat-paginator
        [pageSize]="20"
        [pageSizeOptions]="[5, 10, 20, 50, 100, 200]"
      ></mat-paginator>
    </mat-sidenav-content>
  </mat-sidenav-container>
</ng-template>
